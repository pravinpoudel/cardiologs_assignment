<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <title>Sample Site</title>
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.css" integrity="sha512-NtU/Act0MEcVPyqC153eyoq9L+UHkd0s22FjIaKByyA6KtZPrkm/O5c5xzaia4pyCfReCS634HyQ7tJwKNxC/g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
      <link rel="stylesheet" href="/main.css">
      <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.39.0/js/tempusdominus-bootstrap-4.min.js" integrity="sha512-k6/Bkb8Fxf/c1Tkyl39yJwcOZ1P4cRrJu77p83zJjN2Z55prbFHxPs9vN7q3l3+tSMGPDdoH51AEU8Vgo1cgAA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.39.0/css/tempusdominus-bootstrap-4.css" integrity="sha512-ClXpwbczwauhl7XC16/EFu3grIlYTpqTYOwqwAi7rNSqxmTqCpE8VS3ovG+qi61GoxSLnuomxzFXDNcPV1hvCQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
   </head>
   <body>
      <div class="container" >
         <form id="form" onsubmit="return false">
            <div class="form-group" >
               <label for="exampleFormControlFile1">Upload CSV file</label>
               <input type="file" class="form-control-file" id="recordFile" accept=".csv,text/csv">
            </div>
            <div class="form-group">
               <div class="row">
                  <div class="col-sm-6">
                     <div class="form-group">
                        <div class="input-group date" id="datetimepicker1" data-target-input="nearest">
                           <label for="exampleFormControlFile1">Data and Time: </label>  
                           <input type="text" class="form-control datetimepicker-input" id="datetime-picker" data-target="#datetimepicker1"/>
                           <div class="input-group-append" data-target="#datetimepicker1" data-toggle="datetimepicker">
                              <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <button class="btn btn-sm btn-success addbtn" id="csv-upload-btn">Submit Record</button>
         </form>
         <div class="alert alert-danger" id="status" role="alert">
            <strong >It was not valid format</strong>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
         </div>
         <div class="premature_summary">
            <h4> Record Summary </h4>
            <h5> The number of P waves tagged "premature"</h5>
            <span class="digits pCount">200</span>
            <h5> The number of QRS complexes tagged "premature"</h5>
            <span class="digits qrsCount">200</span>
            <h5> Mean heart rate of the recording </h5>
            <span class="digits frequency">200</span>
         </div>
      </div>
      <script>

        //bootstrap time picker part
         let dateMS = 0;
         $('#datetimepicker1').datetimepicker();
         $("#datetimepicker1").on("change.datetimepicker",function({date, oldDate}){
           dateMS = ((date._d).getTime());
         });
         
         document.getElementById('csv-upload-btn').onclick = function(e){
             e.preventDefault();
             const _acceptedFileExtensions = ".csv";
             const statusPara = document.getElementById("status");
             statusPara.style.display = "none";
             let files = document.getElementById("recordFile").files;
             if(files.length == 0 || dateMS === 0){
               statusPara.textContent = " please select a file and time to proceed";
               console.error("All field are required so need to be filled, please select file and time"); 
               }
                     
           else{
               let formData = new FormData();
               let file = files[0];
         
               if(file.name.match(/.(csv)$/i)){
                   document.getElementById('csv-upload-btn').style.display = "none";
                   formData.append("record", file);
                   formData.append("time", dateMS);
                   let xhr = new XMLHttpRequest();
                   xhr.onprogress = function (e) {
                   
                   };
         
                   xhr.onreadystatechange = function(){
                       if(xhr.readyState == 4 && xhr.status == 200){
                           const response = JSON.parse(xhr.responseText);
                           document.getElements("digits PCount")[0].textContent = response.P;
                           document.getElementsByClassName("digits qrsCount")[0].textContent = response.QRS;
                       }
                   };
                   xhr.open("POST", "/POST/delineation", true);
                   xhr.send(formData);
                   }
               else{
                   console.warn("format is not supported");
                   statusPara.style.display = "block";
                   statusPara.textContent = `file  is not a valid file type, please select again`;
               }
           }
         };
      </script>
   </body>
</html>